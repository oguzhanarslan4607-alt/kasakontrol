<!DOCTYPE html>
<html lang="tr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Şirket Gider Takip Sistemi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#111827',
                            card: '#1f2937',
                            border: '#374151',
                            text: '#f3f4f6',
                            muted: '#9ca3af'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js (Grafikler İçin) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tesseract.js (OCR İçin) -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
        
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .calendar-day { transition: all 0.2s; min-height: 80px; display: flex; flex-direction: column; padding: 4px; border: 1px solid #e5e7eb; }
        .dark .calendar-day { border-color: #374151; }
        .calendar-day:hover { background-color: #f9fafb; }
        .dark .calendar-day:hover { background-color: #374151; }
        .calendar-day.selected { border: 2px solid #4f46e5; background-color: #eef2ff; }
        .dark .calendar-day.selected { background-color: #312e81; border-color: #6366f1; }
        .calendar-day.today { background-color: #fff7ed; font-weight: bold; }
        .dark .calendar-day.today { background-color: #431407; }
        
        .has-expense-indicator { margin-top: auto; width: 100%; display: flex; gap: 2px; flex-wrap: wrap; justify-content: center; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background-color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-100 min-h-screen transition-colors duration-200">

    <!-- GİRİŞ EKRANI (LOGIN) -->
    <div id="login-view" class="fixed inset-0 z-50 bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-8 border border-gray-200 dark:border-gray-700">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg transform -rotate-6">
                    <i data-lucide="receipt" class="w-8 h-8 text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Gider Takip Sistemi</h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Yönetici Girişi</p>
            </div>

            <form id="auth-form" class="space-y-4">
                <div id="auth-error" class="hidden p-3 bg-red-50 text-red-700 text-sm rounded-lg"></div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">E-posta Adresi</label>
                    <input type="email" id="auth-email" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Şifre</label>
                    <input type="password" id="auth-password" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="••••••••">
                </div>

                <button type="submit" id="btn-login" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold transition-colors shadow-md flex justify-center items-center">
                    <span>Giriş Yap</span>
                </button>
            </form>
        </div>
    </div>

    <!-- ANA UYGULAMA (Giriş yapılınca görünür) -->
    <div id="app-view" class="hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-20 transition-colors duration-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-600 p-2 rounded-lg">
                        <i data-lucide="receipt" class="w-5 h-5 text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white tracking-tight hidden sm:block">Gider Takip</h1>
                </div>
                <div class="flex items-center gap-2 overflow-x-auto">
                    <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                        <button id="btn-view-active" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm flex items-center gap-1">
                            <i data-lucide="list" class="w-4 h-4"></i> Giderler
                        </button>
                        <button id="btn-view-reports" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white flex items-center gap-1">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Raporlar
                        </button>
                        <button id="btn-view-calendar" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white flex items-center gap-1">
                            <i data-lucide="calendar" class="w-4 h-4"></i> Takvim
                        </button>
                        <button id="btn-view-trash" class="px-3 py-1.5 text-sm font-medium rounded-md flex items-center gap-1 transition-all text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Çöp
                        </button>
                    </div>
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400 transition-colors">
                        <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                    <!-- Logout -->
                    <button onclick="logout()" class="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 text-red-500 transition-colors ml-1" title="Çıkış Yap">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Yükleniyor Göstergesi -->
            <div id="page-loader" class="fixed inset-0 bg-white dark:bg-gray-900 z-40 flex flex-col items-center justify-center hidden">
                <div class="loader w-10 h-10 border-4 border-t-indigo-600 mb-4"></div>
                <p class="text-gray-500 dark:text-gray-400">Veriler Yükleniyor...</p>
            </div>

            <!-- ANA GİDER LİSTESİ VE FORM GÖRÜNÜMÜ -->
            <div id="main-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- SOL: FORM ALANI -->
                <div class="lg:col-span-1">
                    <div id="form-section">
                        <div id="form-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden sticky top-24 transition-colors">
                            <div id="form-header" class="bg-gray-50 dark:bg-gray-700/50 px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i id="form-icon" data-lucide="plus" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
                                    <h3 id="form-title" class="font-semibold text-gray-900 dark:text-white">Yeni Fiş Ekle</h3>
                                </div>
                                <button id="btn-cancel-edit" class="hidden text-xs text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium flex items-center gap-1">
                                    <i data-lucide="x-circle" class="w-4 h-4"></i> İptal
                                </button>
                            </div>
                            
                            <form id="expense-form" class="p-6 space-y-4">
                                <input type="hidden" id="editing-id">

                                <div id="error-msg" class="hidden p-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 text-sm rounded-lg flex items-center gap-2">
                                    <i data-lucide="alert-circle" class="w-4 h-4"></i> <span></span>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Açıklama</label>
                                    <input type="text" id="description" placeholder="Opsiyonel" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>

                                <!-- Dosya Yükleme & OCR -->
                                <div>
                                    <label id="file-label" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">PDF / Görsel (OCR Destekli)</label>
                                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg hover:border-indigo-500 dark:hover:border-indigo-400 transition-colors bg-gray-50 dark:bg-gray-900 hover:bg-white dark:hover:bg-gray-800 cursor-pointer relative group">
                                        <input id="file-upload" type="file" accept=".pdf, .jpg, .png, .jpeg" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                        <div class="space-y-1 text-center pointer-events-none" id="file-display-area">
                                            <i data-lucide="upload" class="mx-auto h-8 w-8 text-gray-400"></i>
                                            <div class="flex text-sm text-gray-600 dark:text-gray-400 justify-center mt-2">
                                                <span class="font-medium text-indigo-600 dark:text-indigo-400 group-hover:text-indigo-500">Dosya Seç</span>
                                            </div>
                                            <p class="text-xs text-gray-400">PNG, JPG, PDF (Max 4MB)</p>
                                        </div>
                                    </div>
                                    <button type="button" id="btn-ocr" onclick="runOCR()" class="mt-2 w-full text-xs flex items-center justify-center gap-1 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 py-1.5 rounded border border-indigo-200 dark:border-indigo-800 disabled:opacity-50" disabled>
                                        <i data-lucide="scan-line" class="w-3 h-3"></i> Yapay Zeka ile Tara
                                    </button>
                                    <div id="ocr-status" class="text-xs text-center mt-1 text-gray-500 hidden"></div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fiş Tarihi</label>
                                    <input type="date" id="expense-date" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fiş No</label>
                                    <input type="text" id="receipt-no" placeholder="Örn: TR-2024-001" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tutar (TL)</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-2 text-gray-400">₺</span>
                                        <input type="number" id="amount" step="0.01" placeholder="0.00" required class="w-full pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Gider Kalemi</label>
                                    <select id="category" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                                        <option value="Ofis">Ofis Giderleri</option>
                                        <option value="Yemek">Yemek & İkram</option>
                                        <option value="Ulaşım">Ulaşım & Yakıt</option>
                                        <option value="Konaklama">Konaklama</option>
                                        <option value="Personel">Personel</option>
                                        <option value="Diğer">Diğer</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="is-recurring" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="is-recurring" class="text-sm text-gray-700 dark:text-gray-300">Her Ay Tekrarla (Otomatik)</label>
                                </div>

                                <button type="submit" id="btn-submit" class="w-full bg-gray-900 dark:bg-indigo-600 hover:bg-gray-800 dark:hover:bg-indigo-700 text-white py-2.5 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span>Gideri Kaydet</span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Sol Panel Çöp Kutusu -->
                    <div class="hidden" id="trash-info-left">
                        <div class="bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-xl p-6 sticky top-24">
                            <div class="flex items-center gap-3 mb-2">
                                <i data-lucide="trash-2" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                                <h3 class="font-bold text-red-900 dark:text-red-300">Çöp Kutusu</h3>
                            </div>
                            <p class="text-sm text-red-700 dark:text-red-400">Buradaki kayıtlar silinmek üzere işaretlenmiştir.</p>
                        </div>
                    </div>
                </div>

                <!-- SAĞ: LİSTE ALANI -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- Arama Paneli -->
                    <div id="search-panel" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 space-y-3">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-gray-900 dark:text-white flex items-center gap-2"><i data-lucide="search" class="w-4 h-4"></i> Arama & Filtreleme</h3>
                            <button id="btn-clear-filter" class="text-xs text-red-600 dark:text-red-400 hover:underline hidden">Filtreyi Temizle</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                            <div class="md:col-span-5 relative">
                                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="search-input" placeholder="Fiş No, Açıklama, Kategori..." class="w-full pl-9 pr-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div class="md:col-span-3"><input type="date" id="filter-start-date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                            <div class="md:col-span-1 flex items-center justify-center text-gray-400 text-sm"><i data-lucide="arrow-right" class="w-4 h-4"></i></div>
                            <div class="md:col-span-3"><input type="date" id="filter-end-date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                        </div>
                    </div>

                    <div id="list-header-container" class="flex items-center justify-between mb-2">
                        <h3 id="list-title" class="font-semibold text-gray-900 dark:text-white text-lg">İşlemler</h3>
                        <button onclick="exportExcel('list')" class="flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-green-700 dark:text-green-300 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/50 transition-colors">
                            <i data-lucide="table" class="w-3.5 h-3.5"></i> Excel
                        </button>
                    </div>

                    <!-- Sağ Panel Çöp Kutusu Uyarısı -->
                    <div class="hidden" id="trash-info-right">
                        <div class="bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-800 rounded-xl p-4 mb-4 flex items-center gap-3">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 dark:text-red-400"></i>
                            <p class="text-sm text-red-700 dark:text-red-400 font-medium">Şu anda silinmiş kayıtları görüntülüyorsunuz.</p>
                        </div>
                    </div>

                    <!-- Boş Durum -->
                    <div id="empty-state" class="hidden bg-white dark:bg-gray-800 rounded-xl p-12 text-center border border-dashed border-gray-300 dark:border-gray-700">
                        <div class="bg-gray-50 dark:bg-gray-700 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="wallet" class="w-8 h-8 text-gray-400 dark:text-gray-500"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Kayıt Bulunamadı</h3>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Liste boş veya arama kriterine uygun veri yok.</p>
                    </div>

                    <!-- Tablo -->
                    <div id="table-container" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tarih</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Fiş Detayı</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Kategori</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tutar</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">İşlem</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-list-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RAPORLAR GÖRÜNÜMÜ -->
            <div id="reports-view" class="hidden space-y-8">
                <div class="flex items-center justify-between">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-1 inline-flex">
                        <button onclick="changeReportPeriod('daily')" id="btn-report-daily" class="px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-indigo-50 text-indigo-700">Günlük</button>
                        <button onclick="changeReportPeriod('monthly')" id="btn-report-monthly" class="px-4 py-2 text-sm font-medium rounded-lg transition-colors text-gray-600 hover:bg-gray-50">Aylık</button>
                        <button onclick="changeReportPeriod('yearly')" id="btn-report-yearly" class="px-4 py-2 text-sm font-medium rounded-lg transition-colors text-gray-600 hover:bg-gray-50">Yıllık</button>
                    </div>
                    <button onclick="exportExcel('report')" class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors shadow-sm"><i data-lucide="table" class="w-4 h-4"></i> Excel'e Aktar</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                        <p id="stat-period-label" class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Bugünkü Toplam Gider</p>
                        <div class="flex items-center justify-between"><h2 id="stat-total-amount" class="text-3xl font-bold text-gray-900 dark:text-white">0,00 ₺</h2><div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-full"><i data-lucide="wallet" class="w-6 h-6 text-green-600 dark:text-green-400"></i></div></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">İşlenen Fiş Adedi</p>
                        <div class="flex items-center justify-between"><h2 id="stat-count" class="text-3xl font-bold text-gray-900 dark:text-white">0</h2><div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-full"><i data-lucide="file-text" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i></div></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">En Yüksek Harcama</p>
                        <div class="flex items-center justify-between"><h2 id="stat-top-cat" class="text-lg font-bold text-gray-900 dark:text-white truncate">-</h2><div class="p-3 bg-orange-50 dark:bg-orange-900/20 rounded-full"><i data-lucide="trending-up" class="w-6 h-6 text-orange-600 dark:text-orange-400"></i></div></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"><h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Kategori Dağılımı</h3><div class="relative h-64 w-full"><canvas id="chart-categories"></canvas></div></div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"><h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Harcama Trendi</h3><div class="relative h-64 w-full"><canvas id="chart-trend"></canvas></div></div>
                </div>
            </div>

            <!-- TAKVİM GÖRÜNÜMÜ -->
            <div id="calendar-view" class="hidden space-y-4">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <div class="bg-gray-50 dark:bg-gray-700/50 px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                                <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full transition-colors"><i data-lucide="chevron-left" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i></button>
                                <h3 class="font-bold text-gray-900 dark:text-white text-lg flex items-center gap-2" id="calendar-month-label"></h3>
                                <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full transition-colors"><i data-lucide="chevron-right" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i></button>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase"><div>Pzt</div><div>Sal</div><div>Çar</div><div>Per</div><div>Cum</div><div>Cmt</div><div>Paz</div></div>
                                <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-sm"></div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden sticky top-24 h-[600px] flex flex-col">
                            <div class="bg-gray-50 dark:bg-gray-700/50 px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                <h3 class="font-semibold text-gray-900 dark:text-white" id="selected-date-title">Tarih Seçiniz</h3>
                            </div>
                            <div id="selected-date-expenses" class="flex-1 overflow-y-auto p-4 space-y-3">
                                <div class="text-center text-gray-400 dark:text-gray-500 mt-10"><i data-lucide="mouse-pointer-click" class="w-12 h-12 mx-auto mb-2 opacity-50"></i><p>İşlemleri görmek için takvimden bir güne tıklayın.</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODAL -->
    <div id="document-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden transform transition-all scale-95" id="modal-content">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                <div><h3 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2"></h3><p id="modal-subtitle" class="text-sm text-gray-500 dark:text-gray-400"></p></div>
                <button id="btn-close-modal" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i></button>
            </div>
            <div class="flex border-b border-gray-200 dark:border-gray-700">
                <button id="tab-file" class="flex-1 py-3 text-sm font-medium text-center transition-colors text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50">Dosya</button>
                <button id="tab-logs" class="flex-1 py-3 text-sm font-medium text-center transition-colors text-gray-500 hover:bg-gray-50">Loglar</button>
            </div>
            <div class="flex-1 bg-gray-100 dark:bg-gray-900 p-4 overflow-auto relative">
                <div id="view-file-container" class="w-full h-full flex items-center justify-center relative"><div class="text-center text-gray-400"><div class="loader mx-auto mb-2"></div><p>Yükleniyor...</p></div></div>
                <div id="view-logs-container" class="hidden max-w-2xl mx-auto space-y-4 w-full h-full overflow-y-auto"></div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex justify-between items-center">
                <div id="modal-desc" class="text-sm text-gray-500 max-w-[50%] truncate"></div>
                <div class="flex items-center gap-4">
                    <button id="btn-download" class="hidden flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm"><i data-lucide="download" class="w-4 h-4"></i>İndir</button>
                    <div id="modal-amount" class="text-xl font-bold text-gray-900 dark:text-white border-l pl-4 border-gray-200 dark:border-gray-700"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, getDocs, doc, onSnapshot, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYtnQ1E2SQTBx3TwlP56joVH6Ycjhkkas",
            authDomain: "kasakontrol-294bc.firebaseapp.com",
            projectId: "kasakontrol-294bc",
            storageBucket: "kasakontrol-294bc.firebasestorage.app",
            messagingSenderId: "1072559097960",
            appId: "1:1072559097960:web:2f831c747408028b9b13dd",
            measurementId: "G-D6PHMX93VQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        let currentUser = null;
        let expenses = [];
        let currentView = 'active'; 
        let editingId = null;
        let fileData = null; 
        let fileName = '';
        let fileType = '';
        let isZoomed = false;
        let currentDocData = null;
        let reportPeriod = 'daily'; 
        
        let currentCalendarDate = new Date();
        let selectedDate = null;
        let searchQuery = '';
        let filterStartDate = '';
        let filterEndDate = '';

        let chartInstance1 = null;
        let chartInstance2 = null;

        // --- GLOBAL FUNCTIONS FOR HTML ACCESS ---
        window.toggleTheme = () => {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            }
            updateThemeIcon();
            if(currentView === 'reports') renderReports();
        };

        function updateThemeIcon() {
            const icon = document.getElementById('theme-icon');
            if(!icon) return;
            if (document.documentElement.classList.contains('dark')) icon.setAttribute('data-lucide', 'sun');
            else icon.setAttribute('data-lucide', 'moon');
            lucide.createIcons();
        }

        window.logout = () => {
            signOut(auth).then(() => {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
                currentUser = null;
            });
        };

        window.changeReportPeriod = (period) => {
            reportPeriod = period;
            renderReports(); // Re-render logic handles styles
        };

        window.changeCalendarMonth = (offset) => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendarView();
        };

        window.toggleZoom = () => {
            const img = document.getElementById('doc-image'); 
            const icon = document.getElementById('zoom-icon');
            const cont = document.getElementById('view-file-container');
            if(!img) return;
            isZoomed = !isZoomed;
            if (isZoomed) { 
                img.style.minWidth = '100%'; 
                img.className = "w-auto h-auto max-w-none cursor-zoom-out"; 
                cont.classList.remove('items-center', 'justify-center'); 
                if(icon) icon.setAttribute('data-lucide', 'zoom-out'); 
            } else { 
                img.style.minWidth = ''; 
                img.className = "max-w-full max-h-full object-contain cursor-zoom-in transition-all duration-300"; 
                cont.classList.add('items-center', 'justify-center'); 
                if(icon) icon.setAttribute('data-lucide', 'zoom-in'); 
            }
            lucide.createIcons();
        };

        window.exportExcel = exportExcel;
        window.runOCR = runOCR;

        window.onload = () => {
            lucide.createIcons();
            
            // Dark Mode Init
            if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            updateThemeIcon();

            // Auth State
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('login-view').classList.add('hidden');
                    document.getElementById('app-view').classList.remove('hidden');
                    startDataListener();
                } else {
                    document.getElementById('login-view').classList.remove('hidden');
                    document.getElementById('app-view').classList.add('hidden');
                }
            });

            setupEventListeners();
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
        };

        function setupEventListeners() {
            // Auth Forms
            const authForm = document.getElementById('auth-form');
            const authError = document.getElementById('auth-error');

            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-password').value;
                authError.classList.add('hidden');

                // ADMIN CHECK
                if(email !== "admin@zafer.com") {
                    authError.innerText = "Sadece yönetici girişi yapılabilir.";
                    authError.classList.remove('hidden');
                    return;
                }
                
                signInWithEmailAndPassword(auth, email, pass).catch(err => {
                    // AUTO CREATE ADMIN IF NOT EXISTS
                    if(err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                        // Check if password matches the requested one for first time creation safety
                        if(pass === "313131") {
                            createUserWithEmailAndPassword(auth, email, pass).then(() => {
                                alert("Yönetici hesabı oluşturuldu ve giriş yapıldı.");
                            }).catch(createErr => {
                                authError.innerText = "Kayıt Hatası: " + createErr.message;
                                authError.classList.remove('hidden');
                            });
                        } else {
                            authError.innerText = "Giriş Hatası: Kullanıcı bulunamadı veya şifre yanlış.";
                            authError.classList.remove('hidden');
                        }
                    } else {
                        authError.innerText = "Giriş Hatası: " + err.message;
                        authError.classList.remove('hidden');
                    }
                });
            });

            // App Navigation
            document.getElementById('btn-view-active').addEventListener('click', () => changeView('active'));
            document.getElementById('btn-view-trash').addEventListener('click', () => changeView('trash'));
            document.getElementById('btn-view-reports').addEventListener('click', () => changeView('reports'));
            document.getElementById('btn-view-calendar').addEventListener('click', () => changeView('calendar'));

            // Filter
            document.getElementById('search-input').addEventListener('input', (e) => { searchQuery = e.target.value.toLowerCase(); renderList(); });
            document.getElementById('filter-start-date').addEventListener('change', (e) => { filterStartDate = e.target.value; renderList(); toggleClearFilterBtn(); });
            document.getElementById('filter-end-date').addEventListener('change', (e) => { filterEndDate = e.target.value; renderList(); toggleClearFilterBtn(); });
            document.getElementById('btn-clear-filter').addEventListener('click', clearFilters);

            // Expense Form
            document.getElementById('file-upload').addEventListener('change', handleFileSelect);
            document.getElementById('expense-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('btn-cancel-edit').addEventListener('click', resetForm);

            // Modal
            document.getElementById('btn-close-modal').addEventListener('click', closeModal);
            document.getElementById('tab-file').addEventListener('click', () => switchModalTab('file'));
            document.getElementById('tab-logs').addEventListener('click', () => switchModalTab('logs'));
            document.getElementById('btn-download').addEventListener('click', downloadFile);
            document.getElementById('document-modal').addEventListener('click', (e) => { if(e.target === document.getElementById('document-modal')) closeModal(); });
        }

        // --- DATA ---
        function startDataListener() {
            // Using public data path so all users share data (as per previous request)
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'));
            
            // To make it private per user, change to: 
            // collection(db, 'artifacts', appId, 'users', currentUser.uid, 'expenses')

            onSnapshot(q, (snapshot) => {
                const list = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                list.sort((a, b) => {
                    const dateA = a.expenseDate ? new Date(a.expenseDate) : new Date(a.createdAt);
                    const dateB = b.expenseDate ? new Date(b.expenseDate) : new Date(b.createdAt);
                    return dateB - dateA;
                });
                expenses = list;
                
                // Refresh current view
                if(currentView === 'reports') renderReports();
                else if(currentView === 'calendar') renderCalendarView();
                else renderList();
                
                document.getElementById('page-loader').classList.add('hidden');
            });
        }

        // --- VIEW LOGIC ---
        function changeView(view) {
            currentView = view;
            const btnActive = document.getElementById('btn-view-active');
            const btnTrash = document.getElementById('btn-view-trash');
            const btnReports = document.getElementById('btn-view-reports');
            const btnCalendar = document.getElementById('btn-view-calendar');
            
            const mainView = document.getElementById('main-view');
            const reportsView = document.getElementById('reports-view');
            const calendarView = document.getElementById('calendar-view');
            const searchPanel = document.getElementById('search-panel');

            // Reset classes
            const inactiveClass = "px-3 py-1.5 text-sm font-medium rounded-md transition-all text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-white flex items-center gap-1";
            btnActive.className = inactiveClass;
            btnTrash.className = inactiveClass;
            btnReports.className = inactiveClass;
            btnCalendar.className = inactiveClass;

            mainView.classList.add('hidden');
            reportsView.classList.add('hidden');
            calendarView.classList.add('hidden');
            searchPanel.classList.add('hidden');

            if (view === 'active') {
                btnActive.className = "px-3 py-1.5 text-sm font-medium rounded-md transition-all bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm flex items-center gap-1";
                mainView.classList.remove('hidden');
                searchPanel.classList.remove('hidden');
                document.getElementById('form-section').classList.remove('hidden');
                document.getElementById('trash-info-left').classList.add('hidden');
                document.getElementById('trash-info-right').classList.add('hidden');
                document.getElementById('list-title').innerText = "İşlemler";
                renderList();
            } else if (view === 'trash') {
                btnTrash.className = "px-3 py-1.5 text-sm font-medium rounded-md flex items-center gap-1 transition-all bg-white dark:bg-gray-600 text-red-600 dark:text-red-400 shadow-sm";
                mainView.classList.remove('hidden');
                searchPanel.classList.remove('hidden');
                document.getElementById('form-section').classList.add('hidden');
                document.getElementById('trash-info-left').classList.remove('hidden');
                document.getElementById('trash-info-right').classList.remove('hidden');
                document.getElementById('list-title').innerText = "Silinmiş Kayıtlar";
                renderList();
            } else if (view === 'reports') {
                btnReports.className = "px-3 py-1.5 text-sm font-medium rounded-md transition-all bg-white dark:bg-gray-600 text-indigo-600 dark:text-indigo-400 shadow-sm flex items-center gap-1";
                reportsView.classList.remove('hidden');
                renderReports();
            } else if (view === 'calendar') {
                btnCalendar.className = "px-3 py-1.5 text-sm font-medium rounded-md transition-all bg-white dark:bg-gray-600 text-indigo-600 dark:text-indigo-400 shadow-sm flex items-center gap-1";
                calendarView.classList.remove('hidden');
                renderCalendarView();
            }
        }

        // --- LIST RENDER ---
        function renderList() {
            let filtered = expenses.filter(item => currentView === 'active' ? !item.isDeleted : item.isDeleted);

            if (searchQuery) {
                filtered = filtered.filter(item => 
                    (item.receiptNo && item.receiptNo.toLowerCase().includes(searchQuery)) ||
                    (item.description && item.description.toLowerCase().includes(searchQuery)) ||
                    (item.category && item.category.toLowerCase().includes(searchQuery))
                );
            }
            if (filterStartDate) filtered = filtered.filter(item => item.expenseDate >= filterStartDate);
            if (filterEndDate) filtered = filtered.filter(item => item.expenseDate <= filterEndDate);

            const tbody = document.getElementById('expense-list-body');
            const empty = document.getElementById('empty-state');
            const table = document.getElementById('table-container');

            if (filtered.length === 0) {
                empty.classList.remove('hidden');
                table.classList.add('hidden');
            } else {
                empty.classList.add('hidden');
                table.classList.remove('hidden');
                tbody.innerHTML = '';

                filtered.forEach(expense => {
                    const date = expense.expenseDate ? new Date(expense.expenseDate).toLocaleDateString('tr-TR') : '-';
                    const hasFile = expense.hasFile || !!expense.fileData;
                    
                    const colors = {'Ofis':'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300','Yemek':'bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300','Ulaşım':'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300','Konaklama':'bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300','Personel':'bg-pink-100 text-pink-700 dark:bg-pink-900/40 dark:text-pink-300','Diğer':'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'};
                    const catColor = colors[expense.category] || 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';

                    const tr = document.createElement('tr');
                    tr.className = `hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors ${editingId === expense.id ? 'bg-indigo-50/50 dark:bg-indigo-900/20' : ''}`;
                    
                    // Buttons
                    let btns = `<button onclick="window.openModal('${expense.id}')" class="p-1.5 rounded-md text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors"><i data-lucide="eye" class="w-4 h-4"></i></button>`;
                    
                    if (currentView === 'active') {
                        const editClass = editingId === expense.id ? 'text-indigo-600 dark:text-indigo-400 bg-indigo-100 dark:bg-indigo-900/40' : 'text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30';
                        btns += `<button onclick="window.loadExpenseToForm('${expense.id}')" class="p-1.5 rounded-md transition-colors ${editClass}" ${editingId === expense.id ? 'disabled' : ''}><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                 <button onclick="window.softDelete('${expense.id}')" class="p-1.5 rounded-md text-gray-400 hover:text-red-500 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    } else {
                        btns += `<button onclick="window.restoreExpense('${expense.id}')" class="p-1.5 rounded-md text-green-500 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300 hover:bg-green-50 dark:hover:bg-green-900/30 transition-colors"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                                 <button onclick="window.permanentDelete('${expense.id}')" class="p-1.5 rounded-md text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/30 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    }

                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col"><span class="font-medium text-gray-700 dark:text-gray-300">${date}</span>${hasFile ? `<span class="flex items-center gap-1 text-xs text-indigo-600 dark:text-indigo-400 mt-1"><i data-lucide="file-text" class="w-3 h-3"></i><span class="truncate max-w-[80px]">Dosya</span></span>` : ``}</div>
                        </td>
                        <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900 dark:text-white">${expense.receiptNo}</div><div class="text-xs text-gray-500 dark:text-gray-400 truncate max-w-[150px]">${expense.description || ''}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${catColor}">${expense.category}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-gray-900 dark:text-white">${formatCurrency(expense.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><div class="flex items-center justify-end gap-2">${btns}</div></td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            }
        }

        // Globals for HTML onclicks
        window.openModal = (id) => { const e = expenses.find(x => x.id === id); if(e) openModal(e); };
        window.loadExpenseToForm = (id) => { const e = expenses.find(x => x.id === id); if(e) loadExpenseToForm(e); };
        window.softDelete = softDelete;
        window.restoreExpense = restoreExpense;
        window.permanentDelete = permanentDelete;

        // --- REPORTS & CHARTS ---
        function renderReports() {
            const activeList = expenses.filter(e => !e.isDeleted);
            let filteredList = [];
            const today = new Date();
            let labelText = "";

            if (reportPeriod === 'daily') {
                const todayStr = today.toISOString().split('T')[0];
                filteredList = activeList.filter(e => e.expenseDate === todayStr);
                labelText = "Bugünkü";
            } else if (reportPeriod === 'monthly') {
                const currentMonth = today.toISOString().slice(0, 7);
                filteredList = activeList.filter(e => e.expenseDate && e.expenseDate.startsWith(currentMonth));
                labelText = "Bu Ayki";
            } else if (reportPeriod === 'yearly') {
                const currentYear = today.getFullYear().toString();
                filteredList = activeList.filter(e => e.expenseDate && e.expenseDate.startsWith(currentYear));
                labelText = "Bu Yılki";
            }

            // Button Styles
            ['daily','monthly','yearly'].forEach(p => {
                const btn = document.getElementById('btn-report-'+p);
                if(!btn) return;
                if(p === reportPeriod) btn.className = "px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-indigo-50 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300";
                else btn.className = "px-4 py-2 text-sm font-medium rounded-lg transition-colors text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700";
            });

            const total = filteredList.reduce((sum, item) => sum + (item.amount || 0), 0);
            const count = filteredList.length;
            const catCounts = {};
            filteredList.forEach(item => { catCounts[item.category] = (catCounts[item.category] || 0) + (item.amount || 0); });
            const topCategory = Object.keys(catCounts).length > 0 ? Object.entries(catCounts).sort((a,b) => b[1] - a[1])[0][0] : '-';

            document.getElementById('stat-period-label').innerText = `${labelText} Toplam Gider`;
            document.getElementById('stat-total-amount').innerText = formatCurrency(total);
            document.getElementById('stat-count').innerText = count;
            document.getElementById('stat-top-cat').innerText = topCategory;

            renderCharts(filteredList);
        }

        function renderCharts(data) {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            
            // Pie
            const catCounts = {};
            data.forEach(item => { catCounts[item.category] = (catCounts[item.category] || 0) + item.amount; });
            const ctxCat = document.getElementById('chart-categories');
            if(ctxCat) {
                if(chartInstance1) chartInstance1.destroy();
                chartInstance1 = new Chart(ctxCat.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(catCounts),
                        datasets: [{ data: Object.values(catCounts), backgroundColor: ['#3b82f6','#f97316','#22c55e','#a855f7','#ec4899','#6b7280'], borderWidth: 1 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: textColor } } } }
                });
            }

            // Bar
            const dateCounts = {};
            data.sort((a,b) => a.expenseDate.localeCompare(b.expenseDate));
            data.forEach(item => { const d = item.expenseDate||'Tarihsiz'; dateCounts[d] = (dateCounts[d]||0) + item.amount; });
            const ctxTrend = document.getElementById('chart-trend');
            if(ctxTrend) {
                if(chartInstance2) chartInstance2.destroy();
                chartInstance2 = new Chart(ctxTrend.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(dateCounts),
                        datasets: [{ label: 'Günlük Toplam (TL)', data: Object.values(dateCounts), backgroundColor: '#6366f1', borderWidth: 1 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: textColor } }, x: { ticks: { color: textColor } } }, plugins: { legend: { labels: { color: textColor } } } }
                });
            }
        }

        // --- CALENDAR ---
        function renderCalendarView() {
            const calendarGrid = document.getElementById('calendar-grid');
            if(!calendarGrid) return;
            calendarGrid.innerHTML = '';
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const todayStr = new Date().toISOString().split('T')[0];
            const monthNames = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
            document.getElementById('calendar-month-label').innerHTML = `<i data-lucide="calendar" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i> ${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            let startDayIndex = firstDay.getDay(); if (startDayIndex === 0) startDayIndex = 7; startDayIndex -= 1;

            const activeExpenses = expenses.filter(e => !e.isDeleted);

            for (let i = 0; i < startDayIndex; i++) calendarGrid.innerHTML += `<div></div>`;

            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const dailyExpenses = activeExpenses.filter(e => e.expenseDate === dayStr);
                const hasExpense = dailyExpenses.length > 0;
                
                const dayDiv = document.createElement('div');
                let className = "calendar-day rounded-lg cursor-pointer";
                if(dayStr === todayStr) className += " today";
                if(selectedDate === dayStr) className += " selected";
                
                dayDiv.className = className;
                dayDiv.onclick = () => { selectedDate = dayStr; renderCalendarView(); };

                let dotsHtml = '';
                if(hasExpense) {
                    dotsHtml = `<div class="has-expense-indicator">`;
                    for(let k=0; k<Math.min(dailyExpenses.length, 3); k++) dotsHtml += `<div class="dot"></div>`;
                    if(dailyExpenses.length > 3) dotsHtml += `<span class="text-[8px] text-indigo-600 dark:text-indigo-400 leading-none">+</span>`;
                    dotsHtml += `</div>`;
                }
                dayDiv.innerHTML = `<span class="text-sm text-gray-700 dark:text-gray-300">${i}</span>${dotsHtml}`;
                calendarGrid.appendChild(dayDiv);
            }
            lucide.createIcons();
            if(selectedDate) renderSelectedDateDetails();
        }

        function renderSelectedDateDetails() {
            const container = document.getElementById('selected-date-expenses');
            const title = document.getElementById('selected-date-title');
            if(!container) return;

            if (!selectedDate) {
                container.innerHTML = `<div class="text-center text-gray-400 dark:text-gray-500 mt-10"><i data-lucide="mouse-pointer-click" class="w-12 h-12 mx-auto mb-2 opacity-50"></i><p>Tarih seçin.</p></div>`;
                title.innerText = "Tarih Seçiniz";
                lucide.createIcons();
                return;
            }

            const dateObj = new Date(selectedDate);
            title.innerText = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });

            const dailyList = expenses.filter(e => !e.isDeleted && e.expenseDate === selectedDate);

            if (dailyList.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 dark:text-gray-500 py-8"><p>Kayıt yok.</p></div>`;
            } else {
                let html = '';
                dailyList.forEach(ex => {
                    const colors = {'Ofis':'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300','Yemek':'bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300','Ulaşım':'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300','Konaklama':'bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300','Personel':'bg-pink-100 text-pink-700 dark:bg-pink-900/40 dark:text-pink-300','Diğer':'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'};
                    const catColor = colors[ex.category] || 'bg-gray-100';
                    html += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-100 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer" onclick="window.openModal('${ex.id}')">
                            <div class="flex-1 min-w-0 mr-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold text-gray-900 dark:text-white">${ex.receiptNo}</span>
                                    <span class="px-1.5 py-0.5 rounded-full text-[10px] font-semibold ${catColor}">${ex.category}</span>
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${ex.description || 'Açıklama yok'}</p>
                            </div>
                            <div class="text-right">
                                <span class="block text-sm font-bold text-gray-900 dark:text-white">${formatCurrency(ex.amount)}</span>
                                ${ex.hasFile || ex.fileData ? '<i data-lucide="paperclip" class="w-3 h-3 text-indigo-400 inline-block"></i>' : ''}
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
            lucide.createIcons();
        }

        // --- FORM HANDLING ---
        function handleFileSelect(e) {
            const file = e.target.files[0];
            const btnOcr = document.getElementById('btn-ocr');
            const fileDisplay = document.getElementById('file-display-area');
            if (file) {
                if (file.size > 4 * 1024 * 1024) { alert('Maksimum 4MB!'); e.target.value = ""; return; }
                fileName = file.name; fileType = file.type;
                const reader = new FileReader();
                reader.onloadend = () => {
                    fileData = reader.result;
                    fileDisplay.innerHTML = `<div class="flex flex-col items-center justify-center text-green-600 gap-1"><i data-lucide="file-text" class="h-6 w-6"></i><span class="text-sm font-medium truncate max-w-[200px]">${fileName}</span></div>`;
                    btnOcr.disabled = false;
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!currentUser) return;
            const btnSubmit = document.getElementById('btn-submit');
            btnSubmit.disabled = true; btnSubmit.innerText = "İşleniyor...";

            try {
                const data = {
                    expenseDate: document.getElementById('expense-date').value,
                    receiptNo: document.getElementById('receipt-no').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    category: document.getElementById('category').value,
                    description: document.getElementById('description').value,
                    isRecurring: document.getElementById('is-recurring').checked
                };
                
                const changes = [];
                if (editingId) {
                    const oldDoc = expenses.find(e => e.id === editingId);
                    const updates = {};
                    if(oldDoc.amount !== data.amount) { updates.amount = data.amount; changes.push("Tutar güncellendi"); }
                    // ... (other fields checks omitted for brevity) ...
                    updates.expenseDate = data.expenseDate; 
                    updates.receiptNo = data.receiptNo;
                    updates.category = data.category;
                    updates.description = data.description;
                    updates.isRecurring = data.isRecurring;

                    if (fileData) {
                        updates.fileName = fileName; updates.fileType = fileType; updates.hasFile = true;
                        await uploadFileChunks(editingId, fileData); changes.push("Dosya güncellendi");
                    }
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', editingId), updates);
                    await createLog(editingId, changes);
                } else {
                    const newDoc = { ...data, fileName: fileName || 'Dosya Yok', fileType: fileType, hasFile: !!fileData, createdAt: Date.now(), isDeleted: false };
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), newDoc);
                    if (fileData) await uploadFileChunks(docRef.id, fileData);
                }
                resetForm();
            } catch (err) { console.error(err); alert("Hata oluştu"); } 
            finally { btnSubmit.disabled = false; btnSubmit.innerHTML = `<span>${editingId?'Değişiklikleri Kaydet':'Gideri Kaydet'}</span>`; }
        }

        async function uploadFileChunks(parentId, fullBase64) {
            const CHUNK_SIZE = 800 * 1024; const chunks = [];
            for (let i = 0; i < fullBase64.length; i += CHUNK_SIZE) chunks.push(fullBase64.slice(i, i + CHUNK_SIZE));
            const promises = chunks.map((chunkData, index) => addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expense_chunks'), { parentExpenseId: parentId, index, data: chunkData }));
            await Promise.all(promises);
        }
        async function createLog(expenseId, changes) {
            if (!changes.length) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), { expenseId, changes, timestamp: Date.now(), type: 'update' });
        }

        function resetForm() {
            editingId = null; 
            document.getElementById('expense-form').reset();
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
            fileData = null; fileName = '';
            document.getElementById('btn-ocr').disabled = true;
            document.getElementById('file-display-area').innerHTML = `<i data-lucide="upload" class="mx-auto h-8 w-8 text-gray-400"></i><div class="flex text-sm text-gray-600 dark:text-gray-400 justify-center mt-2"><span class="font-medium text-indigo-600 dark:text-indigo-400">Dosya Seç</span></div>`;
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('form-title').innerText = "Yeni Fiş Ekle";
            document.getElementById('btn-submit').innerHTML = `<span>Gideri Kaydet</span>`;
            lucide.createIcons();
        }

        function loadExpenseToForm(expense) {
            editingId = expense.id;
            document.getElementById('expense-date').value = expense.expenseDate;
            document.getElementById('receipt-no').value = expense.receiptNo;
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('description').value = expense.description || '';
            document.getElementById('is-recurring').checked = expense.isRecurring || false;
            
            document.getElementById('form-title').innerText = "Kayıt Düzenleniyor";
            document.getElementById('btn-submit').innerText = "Değişiklikleri Kaydet";
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function softDelete(id) { if(confirm('Çöp kutusuna taşınsın mı?')) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id), { isDeleted: true }); }
        async function restoreExpense(id) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id), { isDeleted: false }); }
        async function permanentDelete(id) { if(confirm('KALICI olarak silinecek?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id)); }

        function formatCurrency(val) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(val); }
        function toggleClearFilterBtn() {
            const btn = document.getElementById('btn-clear-filter');
            if(filterStartDate || filterEndDate) btn.classList.remove('hidden'); else btn.classList.add('hidden');
        }
        function clearFilters() {
            document.getElementById('filter-start-date').value = ''; 
            document.getElementById('filter-end-date').value = '';
            document.getElementById('search-input').value = '';
            filterStartDate = ''; filterEndDate = ''; searchQuery = '';
            toggleClearFilterBtn(); renderList();
        }

        // --- EXCEL ---
        function exportExcel(source) {
            let listToExport = [];
            if (source === 'list') {
                listToExport = expenses.filter(item => !item.isDeleted);
                if (searchQuery) listToExport = listToExport.filter(item => (item.receiptNo && item.receiptNo.toLowerCase().includes(searchQuery)) || (item.category && item.category.toLowerCase().includes(searchQuery)));
                if (filterStartDate) listToExport = listToExport.filter(item => item.expenseDate >= filterStartDate);
                if (filterEndDate) listToExport = listToExport.filter(item => item.expenseDate <= filterEndDate);
            } else {
                listToExport = expenses.filter(e => !e.isDeleted);
            }

            let csvContent = "Tarih;Fiş No;Kategori;Tutar;Açıklama;Durum\n";
            listToExport.forEach(e => {
                const row = [
                    e.expenseDate,
                    `"${e.receiptNo || ''}"`,
                    `"${e.category || ''}"`,
                    e.amount.toString().replace('.', ','),
                    `"${(e.description || '').replace(/"/g, '""')}"`,
                    e.isDeleted ? 'Silindi' : 'Aktif'
                ].join(";");
                csvContent += row + "\n";
            });

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `gider_listesi_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- OCR ---
        function runOCR() {
            if (!fileData) { alert("Dosya seçin."); return; }
            const btn = document.getElementById('btn-ocr');
            const status = document.getElementById('ocr-status');
            btn.disabled = true; status.classList.remove('hidden'); status.innerText = "Taranıyor...";
            
            Tesseract.recognize(fileData, 'tur', { logger: m => status.innerText = `İlerleme: %${Math.round(m.progress * 100)}` })
            .then(({ data: { text } }) => {
                console.log(text);
                const receiptMatch = text.match(/(?:Fiş|Fatura|Sıra|Belge)?\s*No[:.\s]*([A-Z0-9-]{2,})/i);
                if (receiptMatch) document.getElementById('receipt-no').value = receiptMatch[1].trim();
                
                const dateMatch = text.match(/(\d{2}[./-]\d{2}[./-]\d{4})/) || text.match(/(\d{4}[./-]\d{2}[./-]\d{2})/);
                if (dateMatch) {
                    let d = dateMatch[0].replace(/\./g, '-').replace(/\//g, '-');
                    if (d.split('-')[0].length === 2) { const p = d.split('-'); d = `${p[2]}-${p[1]}-${p[0]}`; }
                    document.getElementById('expense-date').value = d;
                }

                const prices = text.match(/\b\d+[.,]\d{2}\b/g);
                if (prices) {
                    const amounts = prices.map(p => parseFloat(p.replace(/\./g, '').replace(',', '.'))).filter(n => !isNaN(n));
                    if (amounts.length > 0) document.getElementById('amount').value = Math.max(...amounts);
                }
                status.innerText = "Tamamlandı.";
            }).finally(() => { btn.disabled = false; });
        }

        // --- MODAL ---
        async function openModal(expense) {
            const modal = document.getElementById('document-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSub = document.getElementById('modal-subtitle');
            const modalDesc = document.getElementById('modal-desc');
            const modalAmt = document.getElementById('modal-amount');
            const fileCont = document.getElementById('view-file-container');
            const logCont = document.getElementById('view-logs-container');
            const btnDown = document.getElementById('btn-download');

            modalTitle.innerText = expense.receiptNo;
            modalSub.innerText = `${expense.category} • ${expense.expenseDate}`;
            modalDesc.innerText = expense.description;
            modalAmt.innerText = formatCurrency(expense.amount);
            
            fileCont.innerHTML = "Yükleniyor...";
            fileCont.classList.remove('hidden');
            logCont.classList.add('hidden');
            btnDown.classList.add('hidden');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); document.getElementById('modal-content').classList.remove('scale-95'); }, 10);

            if (expense.hasFile || expense.fileData) {
                try {
                    let fullString = expense.fileData;
                    if (!fullString) {
                        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'expense_chunks'), where('parentExpenseId', '==', expense.id));
                        const s = await getDocs(q);
                        const chunks = s.docs.map(d => d.data()).sort((a,b)=>a.index-b.index);
                        fullString = chunks.map(c=>c.data).join('');
                    }
                    currentDocData = fullString;
                    window.currentDownloadName = expense.fileName || 'belge';
                    
                    if (expense.fileType?.includes('pdf') || expense.fileName?.endsWith('pdf')) {
                        fileCont.innerHTML = `<iframe src="${fullString}" class="w-full h-full"></iframe>`;
                    } else {
                        fileCont.innerHTML = `<img src="${fullString}" class="max-w-full max-h-full object-contain">`;
                    }
                    btnDown.classList.remove('hidden');
                } catch(e) { fileCont.innerText = "Hata"; }
            } else {
                fileCont.innerText = "Dosya Yok";
            }
            
            // Logs
            const qLogs = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), where('expenseId', '==', expense.id));
            getDocs(qLogs).then(s => {
                const logs = s.docs.map(d=>d.data()).sort((a,b)=>b.timestamp-a.timestamp);
                logCont.innerHTML = logs.map(l => `<div class="p-2 border-b text-sm"><span class="text-gray-500">${new Date(l.timestamp).toLocaleString('tr-TR')}</span><ul class="ml-4 list-disc">${l.changes.map(c=>`<li>${c}</li>`).join('')}</ul></div>`).join('') || "Log yok";
            });
        }

        function closeModal() {
            const m = document.getElementById('document-modal');
            m.classList.add('opacity-0');
            document.getElementById('modal-content').classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        function switchModalTab(tab) {
            if(tab === 'file') {
                document.getElementById('view-file-container').classList.remove('hidden');
                document.getElementById('view-logs-container').classList.add('hidden');
            } else {
                document.getElementById('view-file-container').classList.add('hidden');
                document.getElementById('view-logs-container').classList.remove('hidden');
            }
        }

        function downloadFile() {
            if(!currentDocData) return;
            const a = document.createElement('a'); a.href = currentDocData; a.download = window.currentDownloadName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

    </script>
</body>
</html>
